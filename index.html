<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>tag-demo</title>
  <style>
    body {
      font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif
    }
    hr {
      margin: 20px 0;
    }
    select {
      margin: 10px 0;
    }
    p {
      color: burlywood;
    }

    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .tag {
      padding: 5px 10px;
      border: 1px solid #000;
      border-radius: 5px;
      cursor: pointer;
    }
    .tag.active {
      background-color: #000;
      color: #fff;
    }

    .item-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .item {
      padding: 5px 10px;
      border: 1px solid #000;
      border-radius: 15px;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script>
    const { createApp, defineComponent, ref, toRefs, reactive, computed, watch, h, provide, inject } = Vue
    const root = document.querySelector('#app')
    let TagDemo, Tags, Items, Mode, Tag, Item
    TagDemo = defineComponent(
      (props)=>{
        const tags = reactive([])
        props.items.forEach((item)=>{
          item.tags.forEach((tag)=>{
            if(!tags.find((t)=>t.tag === tag)){
              tags.push({tag, isActive: false})
            }
          })
        })
        const modes = ['and', 'or']
        let mode = ref('and')
        let choosenItems = reactive([])

        getItems(mode.value, tags.filter((tag)=>tag.isActive))
        watch(()=>tags, (val)=>{
          getItems(mode.value, val.filter((tag)=>tag.isActive).map((tag)=>tag.tag))
        }, {deep: true})
        watch(()=>mode.value, (val)=>{
          getItems(val, tags.filter((tag)=>tag.isActive).map((tag)=>tag.tag))
        })

        function getItems(mode = modes.value, tags, items = props.items) {
          if(mode === 'and'){
            choosenItems = items.filter((item)=>{
              return tags.every((tag)=>{
                return item.tags.includes(tag)
              })
            })
          }else if(mode === 'or'){
            choosenItems = items.filter((item)=>{
              return tags.some((tag)=>{
                return item.tags.includes(tag)
              })
            })
          }
        }


        return ()=>{
          return (
            [
              h('h2', 'Tag Demo'),
              h('p', 'tags(click to chose):'),
              h(Tags, {tags, 'onUpdate:tags': (val)=>{
                const tag = tags.find((tag)=>tag.tag === val)
                tag.isActive = !tag.isActive
              }}),
              h(Mode, {modes, mode: mode.value, 'onUpdate:mode': (val)=>{mode.value = val}}),
              h('hr'),
              h('p', 'items:'),
              h(Items, {choosenItems})
            ]
          )
        }
      },
      {
        props: {
          items: {
            type: Array,
            required: true,
          },
        }
      }
    )
    TagDemo.comopnents = {
      Tags,
      Items,
      Mode,
    }
    Mode = defineComponent(
      (props, context)=>{
        return()=>{
          return h('select', {onChange: (e)=>{
            context.emit('update:mode', e.target.value)
          }}, props.modes.map((mode)=>{
            return h('option', {value: mode}, mode)
          }),

          )
        }
      },
      {
        props: {
          mode: {
            type: String,
            required: true,
          },
          modes: {
            type: Array,
            required: true,
          }
        },
      }
    )

    Tags = defineComponent(
      (props, context)=>{
        return()=>{
          return h('div', {class: 'tag-container'}, props.tags.map((tag)=>{
            return h(Tag, {tag: tag , onClick: ()=>{ context.emit('update:tags', tag.tag)}},
            )
          }))
        }
      },
      {
        props: {
          tags: {
            type: Array,
            required: true,
          }
        },
      }
    )
    Tags.components = {
      Tag,
    }
    Items = defineComponent(
      (props)=>{
        const choosenItems = toRefs(props.choosenItems)
        return()=>{
          return h('div', {class: 'item-container'}, props.choosenItems.map((item)=>{
            return h(Item, {item})
          }))
        }
      },
      {
        props: {
          choosenItems: {
            type: Array,
            required: true,
          }
        },
      }
    )
    Items.components = {
      Item,
    }
    Tag = defineComponent(
      (props)=>{
        return()=>{
          return h('div', {class: ['tag', {'active': props.tag.isActive}]}, props.tag.tag)
        }
      },
      {
        props: {
          tag: {
            type: Object,
            required: true,
          }
        },
      }
    )
    Item = defineComponent(
      (props)=>{
        return()=>{
          return h('div', {class: 'item'}, props.item.name)
        }
      },
      {
        props: {
          item: {
            type: Object,
            required: true,
          }
        },
      }
    )

    const items = [
      { name: "apple", tags: ["red", "sweet", "round", "fruit", "hard"] },
      { name: "orange", tags: ["orange", "sweet", "round", "fruit", "hard"] },
      { name: "banana", tags: ["yellow", "sweet", "round", "fruit", "soft"] },
      { name: "grapes", tags: ["green", "sweet", "round", "fruit", "soft"] },
      { name: "mango", tags: ["yellow", "sweet", "round", "fruit", "soft"] },
      { name: "pineapple", tags: ["yellow", "sweet", "round", "fruit", "soft"] },
      { name: "watermelon", tags: ["green", "sweet", "round", "fruit", "soft"] },
      { name: "papaya", tags: ["yellow", "sweet", "round", "fruit", "soft"] },
      { name: "strawberry", tags: ["red", "sweet", "round", "fruit", "soft"] },
      { name: "cherry", tags: ["red", "sweet", "round", "fruit", "soft"] },
      { name: "pomegranate", tags: ["red", "sweet", "round", "fruit", "hard"] },
      { name: "guava", tags: ["green", "sweet", "round", "fruit", "soft"] },
      { name: "jackfruit", tags: ["green", "sweet", "round", "fruit", "soft"] },
      { name: "kiwi", tags: ["green", "sweet", "round", "fruit", "soft"] },
      { name: "lemon", tags: ["yellow", "sour", "round", "fruit", "hard"] },
      { name: "lime", tags: ["green", "sour", "round", "fruit", "hard"] },
      { name: "coconut", tags: ["brown", "sweet", "round", "fruit", "hard"] },
      { name: "avocado", tags: ["green", "sweet", "round", "fruit", "soft"] },
      { name: "peach", tags: ["orange", "sweet", "round", "fruit", "soft"] },
      { name: "pear", tags: ["green", "sweet", "round", "fruit", "soft"] },
      { name: "plum", tags: ["purple", "sweet", "round", "fruit", "soft"] },
    ]
    createApp(h(TagDemo, {items})).mount(root)
  </script>
</body>
</html>